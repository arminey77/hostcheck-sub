- set_fact:
    flat_access_list: "{{ _flat_access_list | from_yaml }}"
  vars:
    _flat_access_list: |-
      access_list:
      {% for group in access_list.groups -%}
        {% for port in group.ports %}
          {% for single in groups[group.name] %}
          - {name: {{ single }}, port: {{ port }}}
          {% endfor %}
        {% endfor %}
      {% endfor %}
      {% for single in access_list.singles %}
        {% for port in single.ports %}
      - {name: {{ single.name }}, port: {{ port }}}
        {% endfor %}
      {% endfor %}

- debug:
    msg: "{{flat_access_list}}"

- name: Check group access lists
  access_check:
    dst: "{{ access_item.name }}"
    port: "{{ access_item.port }}"
    timeout: 1
  with_items: "{{ flat_access_list.access_list }}"
  loop_control:
    loop_var: access_item
  register: result

- name: Print denied access list
  debug:
    msg: "{{ result | community.general.json_query('results[?access==`false`].access_item') }}"